<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJM LMP Real-Time Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            background-color: #f0f0f0;
        }
        #map-container {
            height: 90vh;
            width: 100%;
        }
        #controls-container {
            height: 10vh;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border-top: 1px solid #ccc;
        }
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
        #hour-slider {
            width: 50%;
            margin: 0 20px;
        }
        #play-pause-button, #current-time-display {
            font-size: 16px;
        }
        #current-time-display {
            font-weight: bold;
            min-width: 420px; /* Increased width */
            text-align: center;
        }
        .zone-label {
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            pointer-events: none;
        }
        .legend h4 {
            margin-top: 0;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        .legend-item i {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            opacity: 0.8;
            border: 1px solid rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div id="map-container">
        <div id="map"></div>
    </div>
    
    <div id="controls-container">
        <button id="play-pause-button">▶ Play</button>
        <input type="range" id="hour-slider" min="0" max="23" value="0" step="1">
        <div id="current-time-display">Loading date and time...</div>
    </div>

<script>
    // --- 1. Map Initialization ---
    const map = L.map('map').setView([39.8283, -98.5795], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // --- 2. Global Variables ---
    let geojsonLayer;
    let lmpDataByHour = []; 
    let labelMarkers = {};
    let currentHour = 0;
    let animationTimer = null;
    let currentDate;

    // --- 3. DOM Elements ---
    const slider = document.getElementById('hour-slider');
    const playPauseButton = document.getElementById('play-pause-button');
    const timeDisplay = document.getElementById('current-time-display');

    // --- 4. Core Functions ---
    async function fetchZoneShapes() {
        try {
            const response = await fetch('/api/zones');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const geojsonData = await response.json();
            geojsonLayer = L.geoJson(geojsonData, { style: style, onEachFeature: onEachFeature }).addTo(map);
            map.fitBounds(geojsonLayer.getBounds());
        } catch (error) {
            console.error("Error fetching zone shapes:", error);
            alert("Could not load zone shapes. The map will not be drawn.");
        }
    }
    async function fetchLmpData(day = '2025-06-15') {
        currentDate = new Date(day + 'T00:00:00');
        timeDisplay.innerText = "Loading LMP data...";
        try {
            const response = await fetch(`/api/lmp/${day}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const lmpDataByZone = await response.json();
            processLmpData(lmpDataByZone);
            updateMapForHour(0);
        } catch (error) {
            console.error("Error fetching LMP data:", error);
            timeDisplay.innerText = "Failed to load data.";
            alert("Could not load LMP data. The map will not be colored.");
        }
    }
    function processLmpData(lmpDataByZone) {
        lmpDataByHour = Array.from({ length: 24 }, () => ({}));
        for (const zoneName in lmpDataByZone) {
            for (const reading of lmpDataByZone[zoneName]) {
                const hour = new Date(reading.datetime_beginning_ept).getUTCHours();
                if (lmpDataByHour[hour]) {
                    lmpDataByHour[hour][zoneName] = reading.total_lmp_rt;
                }
            }
        }
    }

    // --- 5. Map Styling and Interaction ---
    function getColor(lmp) {
        if (lmp === undefined || lmp === null) return '#808080'; // Grey for No Data
        
        if (lmp > 100)  return '#9e0142'; // Dark Red
        if (lmp > 75)   return '#d53e4f'; // Red
        if (lmp > 62)   return '#f46d43'; // Red-Orange
        if (lmp > 52)   return '#fdae61'; // Orange
        if (lmp > 44)   return '#fee08b'; // Light Orange
        if (lmp > 37)   return '#ffffbf'; // Yellow
        if (lmp > 30)   return '#e6f598'; // Yellow-Green
        if (lmp > 25)   return '#abdda4'; // Light Green
        if (lmp > 20)   return '#66c2a5'; // Green
        if (lmp >= 0)   return '#3288bd'; // Blue-Green
        return '#5e4fa2';                 // Purple for Negative
    }
    function style(feature) {
        const zoneName = feature.properties.zone_name;
        const lmp = lmpDataByHour[currentHour] ? lmpDataByHour[currentHour][zoneName] : null;
        return { fillColor: getColor(lmp), weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7 };
    }
    function highlightFeature(e) {
        const layer = e.target;
        layer.setStyle({ weight: 5, color: '#666', dashArray: '', fillOpacity: 0.7 });
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) layer.bringToFront();
    }
    function resetHighlight(e) { geojsonLayer.resetStyle(e.target); }
    function onEachFeature(feature, layer) {
        layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
        const zoneName = feature.properties.zone_name;
        layer.bindPopup(`<strong>${zoneName || "Unknown Zone"}</strong>`);
        if (zoneName) {
            const center = layer.getBounds().getCenter();
            const label = L.marker(center, {
                icon: L.divIcon({ className: 'zone-label', html: '', iconSize: [80, 20] }),
                interactive: false
            }).addTo(map);
            labelMarkers[zoneName] = label;
        }
    }

    // --- 6. UI Update and Animation Functions ---
    function updatePopupsForHour(hour) {
        if (!lmpDataByHour[hour] || !geojsonLayer) return;
        const lmpDataForHour = lmpDataByHour[hour];
        geojsonLayer.eachLayer(function(layer) {
            const zoneName = layer.feature.properties.zone_name;
            const lmp = lmpDataForHour[zoneName];
            const content = `<strong>${zoneName}</strong><br>LMP: ${lmp !== undefined ? `$${lmp.toFixed(2)}` : 'No data'}`;
            layer.setPopupContent(content);
        });
    }
    function updateLabelsForHour(hour) {
        if (!lmpDataByHour[hour]) return;
        const lmpDataForHour = lmpDataByHour[hour];
        for (const zoneName in labelMarkers) {
            const marker = labelMarkers[zoneName];
            const lmp = lmpDataForHour[zoneName];
            let labelText = (lmp !== null && lmp !== undefined) ? `$${lmp.toFixed(1)}` : '';
            marker.getIcon().options.html = labelText;
            marker.setIcon(marker.getIcon());
        }
    }
    function updateMapForHour(hour) {
        currentHour = parseInt(hour);
        slider.value = currentHour;
        const nextHour = (currentHour + 1) % 24;

        // Format date and time for display
        const dayOfWeek = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
        const dateString = currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        const hourString = `Hour: ${String(currentHour).padStart(2, '0')}:00 - ${String(nextHour).padStart(2, '0')}:00`;

        timeDisplay.innerText = `${dayOfWeek}, ${dateString} | ${hourString}`;

        if (geojsonLayer) {
            geojsonLayer.setStyle(style);
            updatePopupsForHour(currentHour);
            updateLabelsForHour(currentHour);
        }
    }
    function playAnimation() {
        playPauseButton.innerText = '❚❚ Pause';
        playPauseButton.onclick = pauseAnimation;
        animationTimer = setInterval(() => {
            let nextHour = (currentHour + 1) % 24;
            updateMapForHour(nextHour);
            if (nextHour === 23) pauseAnimation();
        }, 1000);
    }
    function pauseAnimation() {
        clearInterval(animationTimer);
        animationTimer = null;
        playPauseButton.innerText = '▶ Play';
        playPauseButton.onclick = playAnimation;
    }

    // --- 7. Event Listeners ---
    slider.addEventListener('input', (e) => {
        if (animationTimer) pauseAnimation();
        updateMapForHour(e.target.value);
    });
    playPauseButton.onclick = playAnimation;

    // --- 8. Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        
        const legend = L.control({position: 'topright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            
            div.innerHTML += '<h4>LMP ($/MWh)</h4>';
            div.innerHTML += `<div class="legend-item"><i style="background:#9e0142"></i><span>> $100</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#d53e4f"></i><span>$75.01 &ndash; $100</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#f46d43"></i><span>$62.01 &ndash; $75</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#fdae61"></i><span>$52.01 &ndash; $62</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#fee08b"></i><span>$44.01 &ndash; $52</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#ffffbf"></i><span>$37.01 &ndash; $44</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#e6f598"></i><span>$30.01 &ndash; $37</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#abdda4"></i><span>$25.01 &ndash; $30</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#66c2a5"></i><span>$20.01 &ndash; $25</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#3288bd"></i><span>$0 &ndash; $20</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#5e4fa2"></i><span>< $0</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#808080"></i><span>No Data</span></div>`;

            return div;
        };
        legend.addTo(map);
        
        fetchZoneShapes().then(() => {
            fetchLmpData();
        });
    });

</script>

</body>
</html>
