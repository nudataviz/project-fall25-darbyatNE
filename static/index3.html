<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJM LMP Real-Time Map</title>
    
    <!-- Leaflet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    
    <!-- D3.js for the time slider -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            background-color: #f0f0f0;
            font-family: system-ui, -apple-system, sans-serif;
        }
        #map-container {
            height: calc(100vh - 60px);
            width: 100%;
        }
        #controls-container {
            height: 60px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border-top: 1px solid #ccc;
            padding: 0 20px;
            gap: 15px;
        }
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
        #hour-slider {
            flex: 1;
            margin: 0 20px;
        }
        #play-pause-button, #current-time-display {
            font-size: 16px;
        }
        #play-pause-button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        #play-pause-button:hover {
            background: #0056b3;
        }
        #current-time-display {
            font-weight: bold;
            min-width: 420px; 
            text-align: center;
        }
        .zone-label {
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            pointer-events: none;
        }
        .legend h4 {
            margin-top: 0;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        .legend-item i {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            opacity: 0.8;
            border: 1px solid rgba(0,0,0,0.2);
        }

        /* Filter Panel Styles */
        #filter-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 1001;
            overflow-y: auto;
            padding: 20px;
        }
        #filter-panel.open {
            right: 0;
        }
        #filter-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #filter-toggle:hover {
            background: #0056b3;
        }
        #filter-panel h3 {
            margin: 0 0 20px 0;
            color: #333;
        }
        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .filter-section h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #555;
        }
        .date-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .date-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .date-input-row label {
            font-weight: 500;
            min-width: 50px;
        }
        .date-input-row input[type="date"] {
            flex: 1;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .days-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .day-button {
            padding: 8px 12px;
            border: 2px solid #007bff;
            border-radius: 20px;
            background: white;
            color: #007bff;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 12px;
        }
        .day-button.active {
            background: #007bff;
            color: white;
        }
        .day-button:hover {
            opacity: 0.8;
        }
        #time-slider-container {
            margin-top: 10px;
        }
        #time-display {
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            text-align: center;
        }
        .apply-filter-btn {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .apply-filter-btn:hover {
            background: #218838;
        }
        .saved-filters {
            margin-top: 20px;
        }
        .saved-filter-item {
            padding: 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .saved-filter-header {
            font-weight: 500;
            margin-bottom: 6px;
        }
        .saved-filter-details {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }
        .saved-filter-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .saved-filter-buttons button {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .load-btn {
            background: #007bff;
            color: white;
        }
        .load-btn:hover {
            background: #0056b3;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        #close-filter {
            float: right;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }
        #close-filter:hover {
            color: #000;
        }
    </style>
</head>
<body>

    <button id="filter-toggle">‚öôÔ∏è Filters</button>

    <div id="filter-panel">
        <button id="close-filter">&times;</button>
        <h3>Date & Time Range Filter</h3>
        
        <div class="filter-section">
            <h4>Date Range</h4>
            <div class="date-inputs">
                <div class="date-input-row">
                    <label>Start:</label>
                    <input type="date" id="start-date" value="2025-07-01">
                </div>
                <div class="date-input-row">
                    <label>End:</label>
                    <input type="date" id="end-date" value="2025-07-14">
                </div>
            </div>
        </div>

        <div class="filter-section">
            <h4>Days of Week</h4>
            <div class="days-container">
                <button class="day-button" data-day="0">Sun</button>
                <button class="day-button active" data-day="1">Mon</button>
                <button class="day-button" data-day="2">Tue</button>
                <button class="day-button" data-day="3">Wed</button>
                <button class="day-button" data-day="4">Thu</button>
                <button class="day-button" data-day="5">Fri</button>
                <button class="day-button active" data-day="6">Sat</button>
            </div>
        </div>

        <div class="filter-section">
            <h4>Time Range</h4>
            <div id="time-display">00:00 ‚Äî 24:00</div>
            <div id="time-slider-container">
                <svg id="time-slider-svg" width="100%" height="80"></svg>
            </div>
        </div>

        <button class="apply-filter-btn" id="apply-filter">üîç Apply Filter & Load Data</button>
        <button class="apply-filter-btn" id="save-filter" style="background: #17a2b8;">üíæ Save Current Filter</button>

        <div class="saved-filters">
            <h4>Saved Filters</h4>
            <div id="saved-filters-list">
                <div style="color: #666; font-style: italic; font-size: 12px;">No saved filters yet</div>
            </div>
        </div>
    </div>

    <div id="map-container">
        <div id="map"></div>
    </div>
    
    <div id="controls-container">
        <button id="play-pause-button">‚ñ∂ Play</button>
        <input type="range" id="hour-slider" min="0" max="0" value="0" step="1">
        <div id="current-time-display">Click "Apply Filter & Load Data" to begin</div>
    </div>

<script>
    // Map
    const map = L.map('map').setView([39.8283, -98.5795], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // GLOBALS 
    let geojsonLayer;
    let timeSeriesData = [];
    let labelMarkers = {};
    let currentTimeIndex = 0;
    let animationTimer = null;

    // Filter state
    let currentFilter = {
        startDate: new Date('2025-07-01'),
        endDate: new Date('2025-07-14'),
        startTime: 0,
        endTime: 24,
        daysOfWeek: [false, true, true, true, true, true, false, true]
    };
    let savedFilters = [];

    // GUI elements
    const slider = document.getElementById('hour-slider');
    const playPauseButton = document.getElementById('play-pause-button');
    const timeDisplay = document.getElementById('current-time-display');
    const filterPanel = document.getElementById('filter-panel');
    const filterToggle = document.getElementById('filter-toggle');
    const closeFilter = document.getElementById('close-filter');

    // Filter panel toggle
    filterToggle.addEventListener('click', () => {
        filterPanel.classList.add('open');
    });
    closeFilter.addEventListener('click', () => {
        filterPanel.classList.remove('open');
    });

    // Initialize time slider with D3
    function initTimeSlider() {
        const svgWidth = document.getElementById('time-slider-container').clientWidth;
        const svgHeight = 80;
        const margin = { top: 20, right: 10, bottom: 30, left: 10 };
        const innerWidth = svgWidth - margin.left - margin.right;
        const innerHeight = svgHeight - margin.top - margin.bottom;

        const svg = d3.select("#time-slider-svg")
            .attr("width", svgWidth)
            .attr("height", svgHeight);

        svg.selectAll("*").remove();

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const timeScale = d3.scaleLinear()
            .domain([0, 24])
            .range([0, innerWidth]);

        // Axis
        const axis = d3.axisBottom(timeScale)
            .ticks(12)
            .tickFormat(d => `${d}:00`);

        g.append("g")
            .attr("transform", `translate(0,${innerHeight})`)
            .call(axis)
            .selectAll("text")
            .style("font-size", "9px");

        // Track
        g.append("line")
            .attr("x1", 0)
            .attr("x2", innerWidth)
            .attr("y1", innerHeight / 2)
            .attr("y2", innerHeight / 2)
            .attr("stroke", "#ddd")
            .attr("stroke-width", 4)
            .attr("stroke-linecap", "round");

        // Selected range
        const rangeRect = g.append("rect")
            .attr("y", innerHeight / 2 - 2)
            .attr("height", 4)
            .attr("fill", "#007bff")
            .attr("rx", 2);

        const handleRadius = 10;

        // Start handle
        const startHandle = g.append("circle")
            .attr("cy", innerHeight / 2)
            .attr("r", handleRadius)
            .attr("fill", "#007bff")
            .attr("stroke", "white")
            .attr("stroke-width", 2)
            .attr("cursor", "ew-resize");

        // End handle
        const endHandle = g.append("circle")
            .attr("cy", innerHeight / 2)
            .attr("r", handleRadius)
            .attr("fill", "#007bff")
            .attr("stroke", "white")
            .attr("stroke-width", 2)
            .attr("cursor", "ew-resize");

        function updateSlider() {
            const x1 = timeScale(currentFilter.startTime);
            const x2 = timeScale(currentFilter.endTime);
            
            startHandle.attr("cx", x1);
            endHandle.attr("cx", x2);
            rangeRect
                .attr("x", x1)
                .attr("width", x2 - x1);
            
            updateTimeDisplay();
        }

        function updateTimeDisplay() {
            const formatTime = (hours) => {
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };
            document.getElementById('time-display').textContent = 
                `${formatTime(currentFilter.startTime)} ‚Äî ${formatTime(currentFilter.endTime)}`;
        }

        const drag = d3.drag()
            .on("drag", function(event, d) {
                const isStart = d === 'start';
                const x = Math.max(0, Math.min(innerWidth, event.x));
                const newTime = timeScale.invert(x);
                
                if (isStart && newTime < currentFilter.endTime) {
                    currentFilter.startTime = newTime;
                    updateSlider();
                } else if (!isStart && newTime > currentFilter.startTime) {
                    currentFilter.endTime = newTime;
                    updateSlider();
                }
            });

        startHandle.datum('start').call(drag);
        endHandle.datum('end').call(drag);

        updateSlider();
    }

    // Day of week buttons
    const dayButtons = document.querySelectorAll('.day-button');
    dayButtons.forEach((button, index) => {
        button.addEventListener('click', () => {
            const dayIndex = parseInt(button.dataset.day);
            currentFilter.daysOfWeek[dayIndex] = !currentFilter.daysOfWeek[dayIndex];
            button.classList.toggle('active');
        });
    });

    // Date inputs
    document.getElementById('start-date').addEventListener('change', (e) => {
        currentFilter.startDate = new Date(e.target.value);
    });
    document.getElementById('end-date').addEventListener('change', (e) => {
        currentFilter.endDate = new Date(e.target.value);
    });

    // Apply filter button
    document.getElementById('apply-filter').addEventListener('click', () => {
        filterPanel.classList.remove('open');
        fetchLmpData();
    });

    // Save filter button
    document.getElementById('save-filter').addEventListener('click', () => {
        const filter = {
            id: Date.now(),
            startDate: new Date(currentFilter.startDate),
            endDate: new Date(currentFilter.endDate),
            startTime: currentFilter.startTime,
            endTime: currentFilter.endTime,
            daysOfWeek: [...currentFilter.daysOfWeek],
            savedAt: new Date()
        };
        savedFilters.push(filter);
        updateSavedFiltersList();
    });

    function updateSavedFiltersList() {
        const container = document.getElementById('saved-filters-list');
        
        if (savedFilters.length === 0) {
            container.innerHTML = '<div style="color: #666; font-style: italic; font-size: 12px;">No saved filters yet</div>';
            return;
        }

        const dayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        
        container.innerHTML = savedFilters.map((filter, index) => {
            const selectedDays = dayLabels.filter((_, i) => filter.daysOfWeek[i]).join(", ");
            const formatTime = (hours) => {
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };
            
            return `
                <div class="saved-filter-item">
                    <div class="saved-filter-header">Filter #${savedFilters.length - index}</div>
                    <div class="saved-filter-details">
                        üìÖ ${filter.startDate.toLocaleDateString()} ‚Äî ${filter.endDate.toLocaleDateString()}<br>
                        ‚è∞ ${formatTime(filter.startTime)} ‚Äî ${formatTime(filter.endTime)}<br>
                        üìÜ ${selectedDays}
                    </div>
                    <div class="saved-filter-buttons">
                        <button class="load-btn" onclick="loadFilter(${index})">Load</button>
                        <button class="delete-btn" onclick="deleteFilter(${index})">Delete</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    window.loadFilter = function(index) {
        const filter = savedFilters[index];
        currentFilter = {
            startDate: new Date(filter.startDate),
            endDate: new Date(filter.endDate),
            startTime: filter.startTime,
            endTime: filter.endTime,
            daysOfWeek: [...filter.daysOfWeek]
        };

        // Update UI
        document.getElementById('start-date').value = filter.startDate.toISOString().split('T')[0];
        document.getElementById('end-date').value = filter.endDate.toISOString().split('T')[0];
        
        dayButtons.forEach((button, i) => {
            const dayIndex = parseInt(button.dataset.day);
            if (currentFilter.daysOfWeek[dayIndex]) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });

        initTimeSlider();
    };

    window.deleteFilter = function(index) {
        savedFilters.splice(index, 1);
        updateSavedFiltersList();
    };

    async function fetchZoneShapes() {
        try {
            const response = await fetch('/api/zones');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const geojsonData = await response.json();
            geojsonLayer = L.geoJson(geojsonData, { style: style, onEachFeature: onEachFeature }).addTo(map);
            map.fitBounds(geojsonLayer.getBounds());
        } catch (error) {
            console.error("Error fetching zone shapes:", error);
            alert("Could not load zone shapes. The map will not be drawn.");
        }
    }

    async function fetchLmpData() {
        timeDisplay.innerText = "Loading LMP data...";
        try {
            // Build hours array from time range
            const hours = Array(24).fill(false);
            const startHour = Math.floor(currentFilter.startTime);
            const endHour = Math.ceil(currentFilter.endTime);
            for (let i = startHour; i < endHour; i++) {
                hours[i] = true;
            }

            // Build days of week array (convert to 1-7, Monday=1, Sunday=7)
            const daysOfWeek = [];
            currentFilter.daysOfWeek.forEach((active, index) => {
                if (active) {
                    // Convert from JS (0=Sun) to API format (1=Mon, 7=Sun)
                    const apiDay = index === 0 ? 7 : index;
                    daysOfWeek.push(apiDay);
                }
            });

            const queryPayload = {
                "start_day": currentFilter.startDate.toISOString().split('T')[0],
                "end_day": currentFilter.endDate.toISOString().split('T')[0],
                "days_of_week": daysOfWeek,
                "hours": hours
            };
            
            console.log("Query payload:", queryPayload);
            
            const response = await fetch('/api/data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(queryPayload),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            
            const lmpDataByZone = await response.json();
            processLmpData(lmpDataByZone);

            if (timeSeriesData.length === 0) {
                timeDisplay.innerText = "No data returned for the selected query.";
                return;
            }

            slider.max = timeSeriesData.length - 1;      
            updateMapForTimeIndex(0); 

        } catch (error) {
            console.error("Error fetching LMP data:", error);
            timeDisplay.innerText = "Failed to load data.";
            alert("Could not load LMP data. The map will not be colored.");
        }
    }

    function processLmpData(lmpDataByZone) {
        const dataByTimestamp = {};

        for (const zoneName in lmpDataByZone) {
            for (const reading of lmpDataByZone[zoneName]) {
                const timestamp = reading.datetime_beginning_ept;
                if (!dataByTimestamp[timestamp]) {
                    dataByTimestamp[timestamp] = {
                        datetime: timestamp,
                        readings: {}
                    };
                }
                dataByTimestamp[timestamp].readings[zoneName] = reading.total_lmp_rt;
            }
        }

        timeSeriesData = Object.values(dataByTimestamp).sort((a, b) => {
            return new Date(a.datetime) - new Date(b.datetime);
        });
    }

    function getColor(lmp) {
        if (lmp === undefined || lmp === null) return '#808080'; 
        if (lmp > 100)  return '#9e0142'; 
        if (lmp > 75)   return '#d53e4f'; 
        if (lmp > 62)   return '#f46d43'; 
        if (lmp > 52)   return '#fdae61'; 
        if (lmp > 44)   return '#fee08b'; 
        if (lmp > 37)   return '#ffffbf'; 
        if (lmp > 30)   return '#e6f598'; 
        if (lmp > 25)   return '#abdda4'; 
        if (lmp > 20)   return '#66c2a5'; 
        if (lmp >= 0)   return '#3288bd'; 
        return '#5e4fa2';                 
    }

    function style(feature) {
        const zoneName = feature.properties.zone_name;
        const currentReadings = timeSeriesData[currentTimeIndex]?.readings;
        const lmp = currentReadings ? currentReadings[zoneName] : null;
        return { fillColor: getColor(lmp), weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7 };
    }

    function highlightFeature(e) {
        const layer = e.target;
        layer.setStyle({ weight: 5, color: '#666', dashArray: '', fillOpacity: 0.7 });
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) layer.bringToFront();
    }

    function resetHighlight(e) { geojsonLayer.resetStyle(e.target); }

    function onEachFeature(feature, layer) {
        layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
        const zoneName = feature.properties.zone_name;
        layer.bindPopup(`<strong>${zoneName || "Unknown Zone"}</strong>`);
        if (zoneName) {
            const center = layer.getBounds().getCenter();
            const label = L.marker(center, {
                icon: L.divIcon({ className: 'zone-label', html: '', iconSize: [80, 20] }),
                interactive: false
            }).addTo(map);
            labelMarkers[zoneName] = label;
        }
    }

    function updatePopupsForTimeIndex(index) {
        const lmpDataForTime = timeSeriesData[index]?.readings;
        if (!lmpDataForTime || !geojsonLayer) return;

        geojsonLayer.eachLayer(function(layer) {
            const zoneName = layer.feature.properties.zone_name;
            const lmp = lmpDataForTime[zoneName];
            const content = `<strong>${zoneName}</strong><br>LMP: ${lmp !== undefined ? `$${lmp.toFixed(2)}` : 'No data'}`;
            layer.setPopupContent(content);
        });
    }

    function updateLabelsForTimeIndex(index) {
        const lmpDataForTime = timeSeriesData[index]?.readings;
        if (!lmpDataForTime) return;

        for (const zoneName in labelMarkers) {
            const marker = labelMarkers[zoneName];
            const lmp = lmpDataForTime[zoneName];
            let labelText = (lmp !== null && lmp !== undefined) ? `$${lmp.toFixed(1)}` : '';
            marker.getIcon().options.html = labelText;
            marker.setIcon(marker.getIcon());
        }
    }

    function updateMapForTimeIndex(index) {
        currentTimeIndex = parseInt(index);
        slider.value = currentTimeIndex;

        const currentDataPoint = timeSeriesData[currentTimeIndex];
        if (!currentDataPoint) return;

        const currentDate = new Date(currentDataPoint.datetime);
        const currentHour = currentDate.getHours();
        const nextHour = (currentHour + 1) % 24;

        const dayOfWeek = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
        const dateString = currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        const hourString = `Hour: ${String(currentHour).padStart(2, '0')}:00 - ${String(nextHour).padStart(2, '0')}:00`;

        timeDisplay.innerText = `${dayOfWeek}, ${dateString} | ${hourString}`;

        if (geojsonLayer) {
            geojsonLayer.setStyle(style);
            updatePopupsForTimeIndex(currentTimeIndex);
            updateLabelsForTimeIndex(currentTimeIndex);
        }
    }

    function playAnimation() {
        playPauseButton.innerText = '‚ùö‚ùö Pause';
        playPauseButton.onclick = pauseAnimation;
        animationTimer = setInterval(() => {
            let nextIndex = currentTimeIndex + 1;
            if (nextIndex >= timeSeriesData.length) {
                pauseAnimation();
                return;
            }
            updateMapForTimeIndex(nextIndex);
        }, 1000);
    }

    function pauseAnimation() {
        clearInterval(animationTimer);
        animationTimer = null;
        playPauseButton.innerText = '‚ñ∂ Play';
        playPauseButton.onclick = playAnimation;
    }

    slider.addEventListener('input', (e) => {
        if (animationTimer) pauseAnimation();
        updateMapForTimeIndex(e.target.value);
    });
    playPauseButton.onclick = playAnimation;

    document.addEventListener('DOMContentLoaded', () => {
        const legend = L.control({position: 'topright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.innerHTML += '<h4>LMP ($/MWh)</h4>';
            div.innerHTML += `<div class="legend-item"><i style="background:#9e0142"></i><span>> $100</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#d53e4f"></i><span>$75.01 &ndash; $100</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#f46d43"></i><span>$62.01 &ndash; $75</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#fdae61"></i><span>$52.01 &ndash; $62</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#fee08b"></i><span>$44.01 &ndash; $52</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#ffffbf"></i><span>$37.01 &ndash; $44</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#e6f598"></i><span>$30.01 &ndash; $37</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#abdda4"></i><span>$25.01 &ndash; $30</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#66c2a5"></i><span>$20.01 &ndash; $25</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#3288bd"></i><span>$0 &ndash; $20</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#5e4fa2"></i><span>< $0</span></div>`;
            div.innerHTML += `<div class="legend-item"><i style="background:#808080"></i><span>No Data</span></div>`;
            return div;
        };
        legend.addTo(map);
        
        // Initialize the time slider
        initTimeSlider();
        
        // Load initial data
        fetchZoneShapes();
    });

</script>

</body>
</html>