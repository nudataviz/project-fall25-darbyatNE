<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJM LMP 3D Map</title>
    <link rel="icon" href="/static/favicon_lmp_32.png" type="image/png">

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        html, body, #map { height: 100%; width: 100%; margin: 0; }
        #map-container { height: 90vh; width: 100%; }
        #controls-container { height: 10vh; width: 100%; display: flex; align-items: center; justify-content: center; background-color: #1a1a1a; border-top: 1px solid #333; color: white; }
        #hour-slider { width: 50%; margin: 0 20px; }
        #play-pause-button, #current-time-display { font-family: Arial, Helvetica, sans-serif; font-size: 16px; }
        #current-time-display { font-weight: bold; min-width: 420px; text-align: center; }
        .mapboxgl-popup-content { background: rgba(40, 40, 40, 0.9); color: white; font-family: Arial, Helvetica, sans-serif; padding: 10px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .mapboxgl-popup-content strong { color: #66c2a5; }
        .legend { padding: 10px; font: 14px/16px Arial, Helvetica, sans-serif; background: rgba(40, 40, 40, 0.9); color: #fff; box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; }
        .legend h4 { margin: 0 0 10px; color: #ccc; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-item i { width: 18px; height: 18px; margin-right: 8px; opacity: 0.9; border: 1px solid rgba(100,100,100,0.3); }
    </style>
</head>
<body>

    <div id="map-container"><div id="map"></div></div>
    <div id="controls-container">
        <button id="play-pause-button">▶ Play</button>
        <input type="range" id="hour-slider" min="0" max="0" value="0" step="1" disabled>
        <div id="current-time-display">Loading map...</div>
    </div>

<script>
    // --- Globals ---
    let map;
    let zoneGeoJson = null;
    let timeSeriesData = [];
    let currentTimeIndex = 0;
    let animationTimer = null;

    // --- UI Elements ---
    const slider = document.getElementById('hour-slider');
    const playPauseButton = document.getElementById('play-pause-button');
    const timeDisplay = document.getElementById('current-time-display');

    // --- Color & Style ---
    const defaultColor = '#808080';

    // --- Main Initialization ---
    async function initializeApp() {
        mapboxgl.accessToken = "pk.eyJ1IjoiYmRhcmIiLCJhIjoiY21od3NqdWtmMDMwNjJxcTF2cm5pcDgxZiJ9._zUfYxCl4qqjDdjzUqGMFQ"; 
        
        map = new mapboxgl.Map({
            container: 'map', style: 'mapbox://styles/mapbox/dark-v11', center: [-80, 40], zoom: 4.5, pitch: 10, bearing: 0, antialias: true
        });
        
        map.dragRotate.disable();
        map.touchZoomRotate.disableRotation();

        map.on('load', () => {
            console.log("Map finished loading. Now adding layers and fetching data.");
            addLegend();
            loadDataAndBuildMap();
        });
    }
    
    function addLegend() {
        const legend = document.createElement('div');
        legend.className = 'info legend';
        legend.innerHTML = `<h4>LMP ($/MWh)</h4>
            <div class="legend-item"><i style="background:#9e0142"></i><span>> $100</span></div>
            <div class="legend-item"><i style="background:#f46d43"></i><span>$75 - $100</span></div>
            <div class="legend-item"><i style="background:#fee08b"></i><span>$50 - $75</span></div>
            <div class="legend-item"><i style="background:#e6f598"></i><span>$30 - $50</span></div>
            <div class="legend-item"><i style="background:#66c2a5"></i><span>$20 - $30</span></div>
            <div class="legend-item"><i style="background:#3288bd"></i><span>$0 - $20</span></div>
            <div class="legend-item"><i style="background:#5e4fa2"></i><span>< $0</span></div>
            <div class="legend-item"><i style="background:${defaultColor}"></i><span>No Data</span></div>`;
        
        class LegendControl {
            onAdd(map) { this._map = map; this._container = legend; return this._container; }
            onRemove() { this._container.parentNode.removeChild(this._container); this._map = undefined; }
        }
        map.addControl(new LegendControl(), 'top-right');
    }

    async function loadDataAndBuildMap() {
        try {
            timeDisplay.innerText = "Loading zone shapes...";
            console.log("Fetching GeoJSON from '/api/zones'...");
            const geojsonResponse = await fetch('/api/zones');
            if (!geojsonResponse.ok) throw new Error(`HTTP error! status: ${geojsonResponse.status} while fetching zones.geojson`);
            zoneGeoJson = await geojsonResponse.json();
            console.log("Successfully loaded zones.geojson.", zoneGeoJson.features.length, "features found.");

            for (const feature of zoneGeoJson.features) {
                feature.properties.lmp_value = null;
            }

            map.addSource('zones', { 'type': 'geojson', 'data': zoneGeoJson });

            map.addLayer({
                'id': 'zone-extrusion',
                'type': 'fill-extrusion',
                'source': 'zones',
                'paint': {
                    // This color logic remains the same and already handles negative prices visually
                    'fill-extrusion-color': [
                        'interpolate',
                        ['linear'],
                        ['coalesce', ['get', 'lmp_value'], 0],
                        -10, '#5e4fa2',  // Negative = Purple
                        0, '#cccccc',    // Price 0 = Light Grey
                        20, '#66c2a5',
                        30, '#e6f598',
                        50, '#fee08b',
                        75, '#f46d43',
                        100, '#9e0142'
                    ],

                    // --- NEW HEIGHT & BASE LOGIC FOR NEGATIVE PRICES ---
                    'fill-extrusion-height': [
                        'case',
                        // Condition: If LMP is less than 0...
                        ['<', ['coalesce', ['get', 'lmp_value'], 0], 0],
                        10000, // ...then the top of the shape is fixed at the 10,000m zero plane.

                        // Default (for prices >= 0):
                        [ // The height is the zero plane PLUS the scaled price.
                            '+',
                            10000,
                            ['*', 2000, ['coalesce', ['get', 'lmp_value'], 0]]
                        ]
                    ],
                    'fill-extrusion-base': [
                        'case',
                        // Condition: If LMP is less than 0...
                        ['<', ['coalesce', ['get', 'lmp_value'], 0], 0],
                        // ...the base is PULLED DOWN from the zero plane, creating a pit.
                        // We use 'max' to ensure the base doesn't go below the actual ground (0m).
                        [
                            'max',
                            0,
                            ['+', 10000, ['*', 2000, ['coalesce', ['get', 'lmp_value'], 0]]]
                        ],

                        // Default (for prices >= 0):
                        10000 // The base is fixed at the 10,000m zero plane.
                    ],
                    // ----------------------------------------------------

                    'fill-extrusion-opacity': 0.85
                }
            });

            map.on('click', 'zone-extrusion', (e) => {
                const props = e.features[0].properties;
                const lmp = props.lmp_value;
                new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(`<strong>${props.zone_name}</strong><br>LMP: ${lmp !== null ? `$${lmp.toFixed(2)}` : 'No data'}`).addTo(map);
            });

            map.on('mouseenter', 'zone-extrusion', () => { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'zone-extrusion', () => { map.getCanvas().style.cursor = ''; });

            await fetchLmpData();

        } catch (error) {
            console.error("--- MAP SETUP FAILED ---", error);
            timeDisplay.innerText = `Failed to load map data. Check console (F12) for details.`;
        }
    }

    async function fetchLmpData() {
        timeDisplay.innerText = "Loading LMP data...";
        try {
            console.log("Fetching LMP data from '/api/lmp/range'...");
            
            const queryPayload = {
                "start_day": "2025-07-13",
                "end_day": "2025-07-19",
                "price_type": "RT", 
                "days_of_week": [2, 3, 4, 5, 6], // MySQL DAYOFWEEK: 1=Sun, 7=Sat
                "hours": [false, false, false, false, false, false, 
                          false, false, false, false, false, false, 
                          false, false, false, true, true, true, 
                          true, true, false, false, false, false]
            };
            
            const response = await fetch('/api/lmp/range', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(queryPayload),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API returned status ${response.status}. Response: ${errorText}`);
            }
            
            const lmpDataByZone = await response.json();
            console.log("Successfully loaded LMP data.");
            processLmpData(lmpDataByZone);

            if (timeSeriesData.length === 0) {
                timeDisplay.innerText = "API returned no data for the selected query.";
                console.warn("LMP data was fetched, but resulted in an empty time series.");
                return;
            }

            slider.max = timeSeriesData.length - 1;
            slider.disabled = false;
            updateMapForTimeIndex(0); 

        } catch (error) {
            console.error("--- LMP DATA FETCH FAILED ---", error);
            timeDisplay.innerText = "Failed to load LMP data. Check console (F12).";
        }
    }

    function processLmpData(lmpDataByZone) {
        const dataByTimestamp = {};
        for (const zoneName in lmpDataByZone) {
            for (const reading of lmpDataByZone[zoneName]) {
                const timestamp = reading.datetime_beginning_ept;
                if (!dataByTimestamp[timestamp]) {
                    dataByTimestamp[timestamp] = { datetime: timestamp, readings: {} };
                }
                dataByTimestamp[timestamp].readings[zoneName] = reading.lmp_value;
            }
        }
        timeSeriesData = Object.values(dataByTimestamp).sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
        console.log(`Processed data into ${timeSeriesData.length} time steps.`);
    }

    function updateMapForTimeIndex(index) {
        currentTimeIndex = parseInt(index);
        slider.value = currentTimeIndex;

        const currentDataPoint = timeSeriesData[currentTimeIndex];
        if (!currentDataPoint || !zoneGeoJson) return;

        const readings = currentDataPoint.readings;
        
        if (index === 0) {
            console.log("Checking for data match between GeoJSON and API data...");
            const geojsonZones = new Set(zoneGeoJson.features.map(f => f.properties.zone_name));
            const apiZones = new Set(Object.keys(readings));
            
            console.log("Zones found in GeoJSON (from 'zone_name' property):",  Array.from(geojsonZones).sort());
            console.log("Zones found in API data:", Array.from(apiZones).sort());

            const missingInGeoJSON = [...apiZones].filter(x => !geojsonZones.has(x));
            const missingInApi = [...geojsonZones].filter(x => !apiZones.has(x));
            
            if (missingInGeoJSON.length > 0) console.warn("Mismatched Data! These zones were in the API data but NOT found in the GeoJSON 'zone_name' property:", missingInGeoJSON);
            if (missingInApi.length > 0) console.warn("Mismatched Data! These zones were in the GeoJSON but NOT in the first API timestamp:", missingInApi);
            if (missingInGeoJSON.length === 0 && missingInApi.length === 0) console.log("Zone names appear to match perfectly. Good!");
        }

        for (const feature of zoneGeoJson.features) {
            const zoneName = feature.properties.zone_name;
            const price = readings[zoneName];
            feature.properties.lmp_value = (price !== undefined) ? price : null;
        }
        
        map.getSource('zones').setData(zoneGeoJson);

        const date = new Date(currentDataPoint.datetime);
        timeDisplay.textContent = date.toLocaleString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true });
    }

    // --- Animation Controls ---
    function playAnimation() {
        playPauseButton.innerText = '❚❚ Pause';
        playPauseButton.onclick = pauseAnimation;
        animationTimer = setInterval(() => {
            let nextIndex = currentTimeIndex + 1;
            if (nextIndex >= timeSeriesData.length) {
                pauseAnimation();
                return;
            }
            updateMapForTimeIndex(nextIndex);
        }, 1000);
    }

    function pauseAnimation() {
        clearInterval(animationTimer);
        animationTimer = null;
        playPauseButton.innerText = '▶ Play';
        playPauseButton.onclick = playAnimation;
    }

    slider.addEventListener('input', (e) => {
        if (animationTimer) pauseAnimation();
        updateMapForTimeIndex(e.target.value);
    });
    
    playPauseButton.onclick = playAnimation;

    // --- Start Everything ---
    initializeApp();

</script>

</body>
</html>